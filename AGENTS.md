âš ï¸ **READ THIS FIRST - CHECK BEFORE EVERY ACTION** âš ï¸

This file contains CRITICAL instructions that MUST be followed in ALL interactions.
These instructions OVERRIDE any default behavior and take precedence over global instructions.

# ðŸš¨ MANDATORY PRE-ACTION CHECKLIST ðŸš¨

Before taking ANY action (commits, PRs, file creation, etc.), verify:
âœ… Does this violate any instruction below?
âœ… Am I about to attribute AI involvement anywhere?
âœ… Am I creating unnecessary files?
âœ… Am I doing more than requested?

# AI Attribution - ABSOLUTE PROHIBITION

- **NEVER EVER** attribute any code, message, or any other part of the repo, or associated metadata, was generated by an AI
- This includes:
  - Git commits (no "Generated with Claude", no "Co-Authored-By: Claude", etc.)
  - GitHub issue descriptions
  - GitHub PRs
  - Code comments
  - Documentation
  - ANY metadata that gets committed to the repository
- **NO DDEV REFERENCES**: Never add ddev-specific paths, commands, or references to the module codebase. The module must remain environment-agnostic and work in any Drupal installation
- **NO EXCEPTIONS** - These rules apply to ALL content that becomes part of the repository

# File Creation Policy - STRICT MINIMALISM

- **NEVER** create files unless they're absolutely necessary for achieving the specific goal
- **ALWAYS** prefer editing an existing file to creating a new one
- **NEVER** proactively create documentation files (\*.md) or README files
- Only create documentation files if **explicitly requested** by the user
- When in doubt, ask before creating any new file

# Scope Control - DO EXACTLY WHAT'S ASKED

- Do what has been asked; nothing more, nothing less
- Do not add "helpful" extras unless specifically requested
- Do not anticipate future needs
- Stay focused on the immediate task

---

# Project Overview

This is a Drupal module that bridges JSON-RPC method plugins with the Model Context Protocol (MCP) specification (version 2025-06-18). The module enables Drupal sites to expose their JSON-RPC methods as MCP tools, allowing AI assistants like Claude Desktop to discover and invoke Drupal functionality.

## Architecture

### Core Concept

The module uses a dual-attribute pattern:

1. **Existing `#[JsonRpcMethod]` attribute** (from jsonrpc module) - Defines the JSON-RPC endpoint
2. **New `#[McpTool]` attribute** (to be implemented) - Marks methods for MCP exposure and adds MCP-specific metadata

### Metadata Transformation Flow

```
JSON-RPC Plugin Definition
    â†“
#[JsonRpcMethod] + #[McpTool] attributes
    â†“
Discovery Service (reads attributes)
    â†“
MCP Tool Normalizer (converts to MCP schema)
    â†“
/mcp/tools/list endpoint (returns MCP-compliant JSON)
```

### Per-Tool Invocation Endpoints

Each discovered MCP tool gets its own dedicated invocation endpoint:

**URL Pattern:** `/mcp/tools/{tool_name}`

**Example:** A tool with ID `cache.rebuild` gets endpoint `/mcp/tools/cache.rebuild`

**HTTP Methods:** GET and POST

**Architecture:**

- `McpToolRoutes` dynamically generates routes for all discovered tools
- Uses `ContainerInjectionInterface` for proper dependency injection
- `McpToolInvokeController` handles invocation with authentication checks
- Supports OAuth2 Bearer token authentication with scope validation

**OAuth2 Authentication:**

Tools can require OAuth2 authentication by adding annotations:

```php
#[McpTool(
  annotations: [
    'auth' => [
      'level' => 'required',
      'scopes' => ['mcp_tools', 'content_management']
    ]
  ]
)]
```

**Token Validation:**

- Tokens are queried with expiration check (only non-expired tokens loaded)
- Revocation status is verified
- Required scopes are validated against token scopes
- Returns proper OAuth2 error responses (401/403 with WWW-Authenticate header)

**Request Format:**

- POST: JSON-RPC payload in request body
- GET: JSON-RPC payload in `query` parameter (URL-encoded JSON)

**Response Format:** Standard JSON-RPC 2.0 response

### Caching Implementation

The module implements comprehensive caching for discovery endpoints to optimize performance:

**Cache Strategy:**

- **Discovery endpoints** (`/mcp/tools/list`, `/mcp/tools/describe`): Permanent caching via `CacheableJsonResponse`
- **Per-tool invocation endpoints** (`/mcp/tools/{tool_name}`): Never cached (executes state-changing operations)
- **Error responses**: Never cached (max-age 0)

**Cache Tags:**

- `jsonrpc_mcp:discovery`: Custom module cache tag, invalidated when:
  - Modules are installed/uninstalled (`hook_modules_installed()`, `hook_modules_uninstalled()`)
  - Cache is manually rebuilt (`drush cache:rebuild`)
  - Programmatic invalidation via `McpToolDiscoveryService::invalidateDiscoveryCache()`
- `user.permissions`: Automatically invalidated by Drupal core when permissions change

**Cache Contexts:**

- `user`: Responses vary by user (permission-based tool filtering)
- `url.query_args:cursor`: Separate cache for each pagination cursor (list endpoint)
- `url.query_args:name`: Separate cache for each tool name (describe endpoint)

**Performance:**

- First request: Full plugin discovery + normalization
- Subsequent requests: Served from page cache (no PHP execution)
- Cache invalidation: Lazy regeneration on next request

**Debugging:**

```bash
# Clear discovery cache manually
drush php:eval "\Drupal::service('jsonrpc_mcp.tool_discovery')->invalidateDiscoveryCache();"

# Test cache behavior
curl -I /mcp/tools/list  # Check cache headers
drush cr && curl /mcp/tools/list | jq  # Fresh discovery after cache clear

# Test per-tool invocation
curl -X POST /mcp/tools/cache.rebuild \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"cache.rebuild","params":{},"id":1}'

# Test with OAuth2 token
curl -X POST /mcp/tools/cache.rebuild \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"cache.rebuild","params":{},"id":1}'
```

### Key Mapping Rules

JSON-RPC to MCP transformation:

- `id` â†’ `name` (unique tool identifier)
- `usage` (TranslatableMarkup) â†’ `description` (string)
- `params` (array of JsonRpcParameterDefinition) â†’ `inputSchema` (JSON Schema object with properties/required)
- `output` (array) â†’ `outputSchema` (JSON Schema)
- `#[McpTool]` provides: `title` (optional), `annotations` (optional metadata)

### JSON Schema Conversion

Parameters must be converted from flat JsonRpcParameterDefinition array to JSON Schema object:

- Parameter `id` â†’ property name
- Parameter `schema` â†’ property schema
- Parameter `required` â†’ added to `required` array
- Parameter `description` â†’ property description

## Dependencies

### Required

- **drupal/jsonrpc** (^3.0.0-beta1) - Provides base JSON-RPC infrastructure with PHP 8 attributes
- PHP 8.1+ (for attribute support)
- Drupal 10.2+ or 11.x

### Important JSON-RPC Module Details

- Uses `Drupal\jsonrpc\Attribute\JsonRpcMethod` (extends Plugin attribute)
- Uses `Drupal\jsonrpc\Attribute\JsonRpcParameterDefinition`
- Plugin discovery via attribute scanning
- Access control inherited from `access` parameter in JsonRpcMethod

## Development Commands

### Testing

```bash
# Run all tests for this module
vendor/bin/phpunit --group jsonrpc_mcp

# Run specific test suite
vendor/bin/phpunit --testsuite=unit
vendor/bin/phpunit --testsuite=kernel
vendor/bin/phpunit --testsuite=functional

# Run single test file
vendor/bin/phpunit tests/src/Unit/YourTest.php
```

### Code Quality

```bash
# Check coding standards
vendor/bin/phpcs --standard=Drupal,DrupalPractice src/ tests/

# Auto-fix coding standards
vendor/bin/phpcbf --standard=Drupal,DrupalPractice src/ tests/

# Static analysis (PHPStan level 5)
vendor/bin/phpstan analyze

# JavaScript/CSS linting
npm run lint:check
npm run lint:fix

# Spell checking
npm run cspell:check
```

### Testing MCP Endpoints

```bash
# Test discovery endpoint (after implementation)
curl https://drupal-site/mcp/tools/list | jq

# Test specific tool discovery
curl https://drupal-site/mcp/tools/list | jq '.tools[] | select(.name == "cache.rebuild")'

# Test with MCP Inspector
npx @modelcontextprotocol/inspector https://drupal-site/mcp/tools/list
```

## Implementation Roadmap (Current State)

The module is currently in initial setup phase. The following components need to be implemented:

1. **`#[McpTool]` PHP Attribute** (`src/Attribute/McpTool.php`)
   - Extends `Drupal\Component\Plugin\Attribute\Plugin`
   - Properties: `title` (optional string), `annotations` (optional array)
   - Should be placed on same class as `#[JsonRpcMethod]`

2. **MCP Tool Discovery Service**
   - Scans for plugins with both `#[JsonRpcMethod]` and `#[McpTool]` attributes
   - Extracts metadata from both attributes
   - Returns merged tool definitions

3. **MCP Tool Normalizer** (`src/Normalizer/McpToolNormalizer.php`)
   - Converts JSON-RPC method definition to MCP tool schema
   - Handles parameter â†’ inputSchema conversion
   - Implements pagination cursor logic

4. **Discovery Controller** (`src/Controller/McpToolsController.php`)
   - Endpoint: `/mcp/tools/list`
   - Query param: `cursor` (optional, for pagination)
   - Returns: `{"tools": [...], "nextCursor": null|string}`

5. **Optional: Well-known Endpoint** (`src/Controller/McpDiscoveryController.php`)
   - Endpoint: `/.well-known/mcp.json`
   - Returns server capabilities and tool endpoint URL

## Standards Compliance

### MCP Specification (2025-06-18)

- Tool schema must include: `name`, `description`, `inputSchema`
- Optional fields: `title`, `outputSchema`, `annotations`
- Pagination via `cursor`/`nextCursor` parameters
- JSON Schema Draft 7 for all schemas

### Security Considerations

- Access control inherited from JSON-RPC `access` parameter (array of permissions)
- All permissions in array must be satisfied (AND logic)
- MCP clients authenticate via standard Drupal authentication
- No new authentication mechanism required

## File Structure

```
src/
â”œâ”€â”€ Attribute/
â”‚   â””â”€â”€ McpTool.php              # [TODO] PHP attribute for MCP marking
â”œâ”€â”€ Controller/
â”‚   â”œâ”€â”€ McpToolsController.php   # [TODO] /mcp/tools/list endpoint
â”‚   â””â”€â”€ McpDiscoveryController.php # [TODO] /.well-known/mcp.json
â”œâ”€â”€ Normalizer/
â”‚   â””â”€â”€ McpToolNormalizer.php    # [TODO] JSON-RPC â†’ MCP conversion
â”œâ”€â”€ Service/
â”‚   â””â”€â”€ McpToolDiscovery.php     # [TODO] Tool discovery service
â””â”€â”€ Trait/
    â””â”€â”€ DebugLoggingTrait.php    # Test helper for debug output

tests/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Unit/                    # Fast unit tests (no Drupal bootstrap)
â”‚   â”œâ”€â”€ Kernel/                  # Kernel tests (minimal bootstrap)
â”‚   â”œâ”€â”€ Functional/              # Browser tests
â”‚   â””â”€â”€ FunctionalJavascript/    # Browser tests with JS
â””â”€â”€ modules/
    â””â”€â”€ jsonrpc_mcp_test/        # Test module for functional tests
```

## Example: Creating an MCP-Enabled JSON-RPC Method

```php
namespace Drupal\mymodule\Plugin\jsonrpc\Method;

use Drupal\Core\StringTranslation\TranslatableMarkup;
use Drupal\jsonrpc\Attribute\JsonRpcMethod;
use Drupal\jsonrpc\Attribute\JsonRpcParameterDefinition;
use Drupal\jsonrpc_mcp\Attribute\McpTool;
use Drupal\jsonrpc\Plugin\JsonRpcMethodBase;
use Drupal\jsonrpc\JsonRpcObject\ParameterBag;

#[JsonRpcMethod(
  id: "mymodule.doSomething",
  usage: new TranslatableMarkup("Performs a custom operation"),
  access: ["administer site configuration"],
  params: [
    'input' => new JsonRpcParameterDefinition(
      'input',
      ["type" => "string"],
      null,
      new TranslatableMarkup("The input value"),
      true
    ),
  ]
)]
#[McpTool(
  title: "Do Something Custom",
  annotations: ['category' => 'custom']
)]
class DoSomething extends JsonRpcMethodBase {

  public function execute(ParameterBag $params): array {
    $input = $params->get('input');
    // Implementation
    return ['result' => $input];
  }

  public static function outputSchema(): array {
    return [
      'type' => 'object',
      'properties' => [
        'result' => ['type' => 'string'],
      ],
    ];
  }
}
```

## Testing Pattern

All test classes use the `@group jsonrpc_mcp` annotation for easy filtering. Test classes follow Drupal naming conventions:

- Unit tests: `tests/src/Unit/*Test.php`
- Kernel tests: `tests/src/Kernel/*Test.php` with `protected static $modules = ['jsonrpc_mcp'];`
- Functional tests: `tests/src/Functional/*Test.php` with module dependencies

The `DebugLoggingTrait` is available for test debugging (outputs to browser_output directory).
